<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test SQL Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .editor-container {
            border: 1px solid #ccc;
            border-radius: 8px;
            margin: 20px 0;
        }
        textarea {
            width: 100%;
            height: 200px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>Test de l'éditeur SQL avec autocomplétion</h1>
    
    <div class="editor-container">
        <h3>Éditeur SQL avec CodeMirror</h3>
        <textarea id="sql-editor" placeholder="-- Tapez votre requête SQL ici...">SELECT * FROM users WHERE </textarea>
    </div>

    <div>
        <h3>Instructions de test :</h3>
        <ul>
            <li>Tapez "SEL" et appuyez sur Ctrl+Espace pour voir l'autocomplétion</li>
            <li>Tapez "users" pour voir les suggestions de tables</li>
            <li>Tapez "id" ou "name" pour voir les suggestions de colonnes</li>
            <li>Utilisez Ctrl+Enter pour "exécuter" (test)</li>
        </ul>
    </div>

    <script type="module">
        // Import des modules CodeMirror
        import { EditorView, keymap } from 'https://cdn.skypack.dev/@codemirror/view'
        import { EditorState } from 'https://cdn.skypack.dev/@codemirror/state'
        import { sql } from 'https://cdn.skypack.dev/@codemirror/lang-sql'
        import { autocompletion, completionKeymap } from 'https://cdn.skypack.dev/@codemirror/autocomplete'
        import { defaultKeymap } from 'https://cdn.skypack.dev/@codemirror/commands'
        import { basicSetup } from 'https://cdn.skypack.dev/codemirror'

        // Schéma de test
        const testSchema = {
            users: ['id', 'name', 'email', 'created_at', 'updated_at'],
            posts: ['id', 'title', 'content', 'user_id', 'created_at'],
            comments: ['id', 'content', 'post_id', 'user_id', 'created_at']
        }

        // Fonction de completion personnalisée
        function createCompletionSource(schema) {
            return (context) => {
                const word = context.matchBefore(/\w*/)
                if (!word) return null

                const options = []

                // Mots-clés SQL
                const sqlKeywords = [
                    'SELECT', 'FROM', 'WHERE', 'JOIN', 'INNER JOIN', 'LEFT JOIN', 'RIGHT JOIN',
                    'GROUP BY', 'ORDER BY', 'HAVING', 'LIMIT', 'OFFSET', 'INSERT', 'UPDATE',
                    'DELETE', 'CREATE', 'ALTER', 'DROP', 'INDEX', 'TABLE', 'DATABASE',
                    'AND', 'OR', 'NOT', 'IN', 'EXISTS', 'BETWEEN', 'LIKE', 'IS NULL',
                    'IS NOT NULL', 'DISTINCT', 'COUNT', 'SUM', 'AVG', 'MIN', 'MAX'
                ]

                sqlKeywords.forEach(keyword => {
                    if (keyword.toLowerCase().startsWith(word.text.toLowerCase())) {
                        options.push({
                            label: keyword,
                            type: 'keyword',
                            info: `Mot-clé SQL: ${keyword}`
                        })
                    }
                })

                // Tables
                Object.keys(schema).forEach(tableName => {
                    if (tableName.toLowerCase().startsWith(word.text.toLowerCase())) {
                        options.push({
                            label: tableName,
                            type: 'class',
                            info: `Table: ${tableName}`
                        })
                    }
                })

                // Colonnes
                Object.entries(schema).forEach(([tableName, columns]) => {
                    columns.forEach(columnName => {
                        if (columnName.toLowerCase().startsWith(word.text.toLowerCase())) {
                            options.push({
                                label: columnName,
                                type: 'property',
                                info: `Colonne de ${tableName}: ${columnName}`
                            })
                        }
                    })
                })

                return {
                    from: word.from,
                    options: options.slice(0, 20),
                    validFor: /^\w*$/
                }
            }
        }

        // Initialisation de l'éditeur
        const textarea = document.getElementById('sql-editor')
        
        const extensions = [
            basicSetup,
            sql({
                schema: testSchema,
                upperCaseKeywords: true
            }),
            autocompletion({
                override: [createCompletionSource(testSchema)]
            }),
            keymap.of([
                ...defaultKeymap,
                ...completionKeymap,
                {
                    key: 'Ctrl-Enter',
                    run: () => {
                        alert('Requête exécutée (test) :\n\n' + view.state.doc.toString())
                        return true
                    }
                }
            ]),
            EditorView.theme({
                '&': {
                    fontSize: '14px',
                    fontFamily: 'Monaco, Menlo, "Ubuntu Mono", monospace'
                },
                '.cm-content': {
                    padding: '12px',
                    minHeight: '200px'
                },
                '.cm-focused': {
                    outline: '2px solid rgb(59 130 246)',
                    outlineOffset: '2px'
                },
                '.cm-editor': {
                    borderRadius: '8px',
                    border: '1px solid rgb(209 213 219)'
                }
            })
        ]

        const state = EditorState.create({
            doc: textarea.value,
            extensions
        })

        const view = new EditorView({
            state,
            parent: textarea.parentNode
        })

        textarea.style.display = 'none'
    </script>
</body>
</html>
